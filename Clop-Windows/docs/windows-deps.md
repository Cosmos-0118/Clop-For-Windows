# Windows Tooling Baseline (Phase 0)

Install these stacks before touching the WPF solution so that every developer gets identical compiler/runtime behaviour.

## SDKs & Toolchain

| Component                      | Target Version                                             | Purpose                                                                                    | Verification                                                                                              |
| ------------------------------ | ---------------------------------------------------------- | ------------------------------------------------------------------------------------------ | --------------------------------------------------------------------------------------------------------- |
| .NET SDK                       | 8.0 LTS (8.0.204 or newer)                                 | Builds the WPF shell, BackgroundService, Core, and CliBridge projects.                     | `dotnet --list-sdks` should show an `8.0.x` entry.                                                        |
| Visual Studio 2022 (Desktop)   | 17.10+ with `.NET desktop`, `WPF`, and `C++ MFC` workloads | Provides XAML tooling, designers, and Explorer integration projects from a single install. | `vswhere -latest -products * -requires Microsoft.VisualStudio.Workload.ManagedDesktop` lists the install. |
| Visual Studio 2022 Build Tools | 17.10+ with `Microsoft.VisualStudio.Workload.VCTools`      | Required for MSIX packaging, Explorer shell extensions, and native helper builds.          | `vswhere -latest -products * -requires Microsoft.VisualStudio.Workload.VCTools` lists the install.        |
| WebView2 Runtime               | Evergreen                                                  | Hosts the Buy-Me-A-Coffee support panel and telemetry opt-in UI inside the WPF app.        | `reg query "HKLM\SOFTWARE\Microsoft\EdgeUpdate\Clients" /s` mentions WebView2.                            |
| LLVM/Clang                     | 17.x                                                       | Used for native helpers (Explorer bridge, possible SIMD image stubs).                      | `clang --version` shows 17.x.                                                                             |
| Windows 11 SDK                 | 10.0.26100.\*                                              | Headers/libs for WPF interop, Explorer integration, and desktop packaging.                 | `Get-ChildItem "$Env:ProgramFiles(x86)\Windows Kits\10\Lib"` lists `26100`.                               |
| Windows SDK tooling (MIDL)     | 10.0.19041+                                                | Provides `midlrt.exe` for COM definitions used by Explorer shell integration.              | `where midlrt.exe` prints the path under `Windows Kits\10\bin`.                                           |

### Install Commands

```powershell
# .NET 8 SDK
winget install --id Microsoft.DotNet.SDK.8 --exact
# VS 2022 Community with WPF + desktop workloads (quiet install takes several minutes)
winget install --id Microsoft.VisualStudio.2022.Community --override "--quiet --wait --norestart --includeRecommended --add Microsoft.VisualStudio.Workload.ManagedDesktop --add Microsoft.VisualStudio.Workload.NativeDesktop --add Microsoft.VisualStudio.Workload.NativeGame"
# VS 2022 Build Tools with VC workload (for CI boxes that skip the full IDE)
winget install --id Microsoft.VisualStudio.2022.BuildTools --override "--quiet --wait --norestart --includeRecommended --add Microsoft.VisualStudio.Workload.VCTools"
# WebView2 runtime (Edge Evergreen)
winget install --id Microsoft.EdgeWebView2Runtime --exact
# LLVM/Clang 17
winget install --id LLVM.LLVM --exact
```

### Verification Commands

```powershell
# SDK + workloads
dotnet --list-sdks
& "$Env:ProgramFiles(x86)\Microsoft Visual Studio\Installer\vswhere.exe" -latest -products * -requires Microsoft.VisualStudio.Workload.ManagedDesktop
& "$Env:ProgramFiles(x86)\Microsoft Visual Studio\Installer\vswhere.exe" -latest -products * -requires Microsoft.VisualStudio.Workload.VCTools
reg query "HKLM\SOFTWARE\Microsoft\EdgeUpdate\Clients" /s | Select-String WebView2
clang --version
where midlrt.exe
```

### Setup Notes

- Run the VS Build Tools installer at least once to accept licenses; otherwise MSIX packaging fails silently.
- Configure a Developer PowerShell prompt that adds `%ProgramFiles%\LLVM\bin` and the VS `VC\Tools` directory to `PATH` so `cl.exe` and `clang.exe` are available during CI builds.
- Replicate macOS' decompression behaviour by extracting third-party binaries into `%LOCALAPPDATA%\Clop\bin\x64` on first launch; mirror the folder names from `Shared.swift` so path concatenation stays the same.

## Third-Party Binary Audit (F0.3)

| Binary                    | macOS Invocation & Arguments                                                                                                                                                                    | Windows Equivalent Plan                                                                                                                                                                       | Licensing / Distribution                                                                                                                                                                                              |
| ------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `pngquant`                | `pngquant --force --quality 0-85                                                                                                                                                                | 0-100 (--ext .png                                                                                                                                                                             | --output out.png) <input>`from`Images.swift` lines 536–676.                                                                                                                                                           | Bundle the official `pngquant.exe` (or compile from source) under `tools/pngquant/` and copy to `%LOCALAPPDATA%\Clop\bin\{arch}`. Ensure the wrapper passes the same `--quality` range and handles `--output` path logic. | GPLv3/commercial dual license. Bundling inside a closed-source app requires buying a commercial license from Kornel Lesiński or shipping the source for this component. |
| `jpegoptim`               | `jpegoptim --keep-all --force --max {68                                                                                                                                                         | 85} --auto-mode --overwrite --dest <tmp>`plus fallback to`jpegoptim-old`(see`Images.swift` 536–610).                                                                                          | Use a MinGW-built `jpegoptim.exe` or replace with `mozjpeg` + equivalent arguments. Ship inside `tools/jpegoptim/` and surface errors when return code ≠ 0 to trigger the fallback path.                              | GPLv2. Requires either open-sourcing the glue or negotiating redistribution rights; document this in LICENSE.                                                                                                             |
| `gifsicle`                | Resize + optimise GIFs: `gifsicle --unoptimize --threads=N --resize-method=box --resize WxH ...` followed by `gifsicle -O{2                                                                     | 3} --lossy={30                                                                                                                                                                                | 80} --threads=N (--colors=256)`(see`Images.swift` 430–560).                                                                                                                                                           | Download `gifsicle.exe` from the official Windows release, store under `tools/gifsicle/`, and ensure the Process runner still pipes through `optimiser.processes` for progress updates.                                   | GPLv2. Same obligations as `jpegoptim`.                                                                                                                                 |
| `gifski`                  | `gifski -o out.gif --width <w> --fps <fps> --quality {60                                                                                                                                        | 90} frame\*.png`(see`Video.swift` 92–150).                                                                                                                                                    | Use the official Rust build (`gifski.exe`) and keep stdout parsing so `updateProgressGifski` continues to work. Place it next to ffmpeg in `tools/gifski/`.                                                           | AGPLv3. Either purchase a commercial license from ImageOptim or keep this component optional with source disclosure.                                                                                                      |
| `ffmpeg`                  | Several pipelines: frame extraction (`ffmpeg -i input -progress pipe:2 -nostats -hide_banner -stats_period 0.1 -fpsmax ... frame%04d.png`), optimised export (`ffmpeg -y -i input [-vcodec h264 | h264_videotoolbox ...] -movflags +faststart -progress pipe:2 ... output`), and audio stripping (`-an`).                                                                                       | Ship the Gyan.dev or BtbN static build as `ffmpeg.exe` and keep the `-progress pipe:2` semantics so stderr parsing stays identical. Expose encoder selection (software vs hardware) using Windows Video Acceleration. | LGPL/GPL depending on codecs; stick to LGPL build or provide attribution + source.                                                                                                                                        |
| `vipsthumbnail` (libvips) | `vipsthumbnail -s WxH -o "%s_size.png[Q=100]" --linear --smartcrop {attention                                                                                                                   | centre} <input>` (`Images.swift` 700–780).                                                                                                                                                    | Use the libvips prebuilt ZIP, include `vipsthumbnail.exe`, and ship the `vips` DLLs alongside it in `tools/libvips/`. Keep the same filename pattern logic so `withSize` continues to work.                           | LGPLv2.1; OK to bundle if DLLs remain unmodified and users can relink. Provide LICENSE copy.                                                                                                                              |
| `ghostscript`             | `gs` invoked via `gsArgs` in `PDF.swift` (150+ flags, lossy/lossless variants, `-sDEVICE=pdfwrite`, `-sFONTPATH=...`, env `GS_LIB`).                                                            | Install `gswin64c.exe` (Ghostscript 10.x) under `tools/ghostscript/` and set `GS_LIB` to the bundled `Resource\Init` directory before launching. Preserve all arguments to maintain fidelity. | AGPL/commercial. Decide whether to purchase an Artifex license or keep Clop Windows open-source compatible.                                                                                                           |

> The WPF app now probes `%ProgramFiles%\gs\gs*\bin\gswin64c.exe` and bundled `tools/ghostscript` automatically. If Ghostscript is missing, the PDF optimiser reports a friendly error instructing you to install it (`winget install Artifex.Ghostscript`) or set `CLOP_GS` to the executable path.
> | `exiftool` | Used for metadata copy/strip: `exiftool -overwrite_original -XResolution=72 -YResolution=72`, `-all=` etc. (see `ClopUtils.swift` 200–260 and `ClopCLI/main.swift` 750+). | Bundle Phil Harvey's `exiftool(-k).exe` renamed to `exiftool.exe`. On Windows, run through `perl`-less single-exe distribution and keep args identical. | GPLv3. Redistribution allowed with notices; include README/changes. |
> | `heif-enc` (libheif) | `heif-enc --avif -q 60 -o out.avif input` and `heif-enc -q 60 -o out.heic input` (`Images.swift` 860–920). | Package `heif-enc.exe` from libheif (requires libde265/aom DLLs) inside `tools/libheif/`, ensure PATH points to needed codecs, and keep quality parameter defaults. | LGPLv3+/GPL. If linking against GPL codecs (aom), treat binary as GPL and document obligations. |
> | `cwebp` | `cwebp -mt -q 60 -sharp_yuv -metadata all input -o out.webp` (`Images.swift` 860–920). | Use Google's official `libwebp` Windows build, copy `cwebp.exe` + DLLs into `tools/libwebp/`, and keep metadata flags enabled. | BSD-style (libwebp). Include NOTICE file; no copyleft obligations. |

**Distribution plan**: place each binary (and dependent DLLs) inside `Clop-Windows/tools/<binary>/` during source control, then copy/extract to `%LOCALAPPDATA%\Clop\bin\{arch}` on first launch (mirrors macOS' `GLOBAL_BIN_DIR`). Keep SHA256 hashes beside each binary and validate before execution. For GPL/AGPL items, document the license in `LICENSE` and add download-source links in `docs/windows-deps.md` so legal can approve redistribution or acquire commercial licenses.

### Ghostscript licensing requirements

- Ghostscript's AGPL requires that any distribution which statically links or bundles the binary must provide complete corresponding source for Clop Windows and any modifications to Ghostscript itself. If we keep Clop Windows proprietary, we must instead purchase an Artifex commercial license.
- Regardless of the path chosen, ship the official Artifex LICENSE + NOTICE files in the installer, and display the attribution inside the Settings → About panel.
- When using the commercial license, lock builds to the licensed version (e.g., 10.05.x) and track the proof-of-purchase in the release checklist so CI artifacts remain compliant.
