# Architecture & Ownership Matrix

This matrix maps every macOS Swift source file to the Windows project area that must re-create it. Behavioural notes call out the quirks that make the feature feel like Clop on macOS.

| Swift Source                                 | Windows Owner / Module                                                     | Behavioural Notes & Parity Calls                                                                                                                                                                                                                               |
| -------------------------------------------- | -------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `Shared.swift`                               | `Core/Shared/Primitives.cs` (Core)                                         | Defines `ClopError`, UTType helpers, crop/device/paper tables, NanoID utilities, optimisation port IDs, and file-path helpers. Keep naming identical for easy diffing and preserve even-size maths for Retina logic.                                           |
| `Clop/ActionButtons.swift`                   | `App/Views/FloatingHud/ActionButtons.xaml(.cs)`                            | Quick actions for each optimiser (stop, restore, downscale, share, copy, aggressive run). Buttons manipulate the `Optimiser` view-model and honor `@Environment(\.preview)` to avoid side effects—replicate that guard in WPF.                                 |
| `Clop/Automation.swift`                      | `BackgroundService/Automation/ShortcutsBridge.cs`                          | Caches Apple Shortcuts, throttles CLI calls, and wires `Optimiser.runAutomation`. Windows version needs the same caching TTL (~60s) and identical shortcut routing for App Service / Power Automate endpoints.                                                 |
| `Clop/BatchCropButton.swift`                 | `App/Views/BatchCropDialog.xaml(.cs)`                                      | Bulk crop UI that reads `Defaults.savedCropSizes`, enforces orientation switching, and triggers `optimiser.crop/downscale` across the current selection manager.                                                                                               |
| `Clop/CherryPicks.swift`                     | `Core/IPC/NamedPipeChannel.cs`, `Core/Shared/FilePath*.cs`                 | Wraps Mach ports for optimiser IPC plus file-path & URL helpers. Replace with Named Pipe or AppService channels but keep the same request/response envelopes, hashing utilities, and safe-filename sanitiser.                                                  |
| `Clop/ClopApp.swift`                         | `App/App.xaml.cs` + `BackgroundService/Watchers`                           | Main app delegate: spins up clipboard/file-system watchers, drag-drop monitors, Buy-Me-A-Coffee support hooks, telemetry, and floating HUD coordination. Windows must mirror pause logic, drag monitors, and Sentry wiring while keeping the CTA non-blocking. |
| `Clop/ClopShortcuts.swift`                   | `Integrations/AppService/Shortcuts/Intents.cs`                             | AppIntents entry points for conversion/downscale/automation. Reproduce parameter validation, error mapping, and output handling so command names and behaviours stay Stable for automation scripts.                                                            |
| `Clop/ClopUtils.swift`                       | `Core/Processes/ProcessRunner.cs`, `Core/Shared/ClopPaths.cs`              | Provides `Proc` wrappers (`tryProc`, `tryProcs`), binary unpacking (`bin.tar.lrz`), workdir management, and EXIF helpers. Windows runner must preserve log collection, retry policy, templated filenames, and workdir layout.                                  |
| `Clop/CompactResult.swift`                   | `App/Views/FloatingHud/CompactResult.xaml(.cs)`                            | Aggregated HUD view with resolution widgets, selection mode, and progress bars. Pay attention to conditions that hide/show old sizes and colour logic for improvements.                                                                                        |
| `Clop/CompareView.swift`                     | `App/Views/ComparePage.xaml(.cs)`                                          | Side-by-side diff UI for images/videos/PDFs. Uses cached `AVPlayerLooper` instances and synchronises playback; Windows needs equivalent MediaPlayer caching and loop sync.                                                                                     |
| `Clop/ContentView.swift`                     | `App/Views/MenuView.xaml(.cs)`                                             | Menubar/Tray UI surfacing clipboard actions, CLI install, backups, automation toggles, and the Buy-Me-A-Coffee support button. Mirrors Defaults-backed toggles and Launch-at-login wiring.                                                                     |
| `Clop/DropZone.swift`                        | `App/Views/DropZoneOverlay.xaml(.cs)` + `BackgroundService/DragManager`    | `DragManager` controls drop-zone visibility, preset zones, modifier-key behaviour, and optimisation queueing. Windows overlay must respect the same modifier semantics (option/control) and drop delegation.                                                   |
| `Clop/FileNameField.swift`                   | `App/Controls/FileNameField.xaml(.cs)`                                     | Inline rename field for floating results using matched-geometry animation and window focus hacks. Ensure the WPF control also toggles editing state off when optimisation restarts.                                                                            |
| `Clop/FloatingResult.swift`                  | `App/Views/FloatingHud/FloatingResult.xaml(.cs)`                           | Primary floating HUD list, `UpdateButton`, drop-zone injection, and auto-hide timers. Keep snap layout, preview guarding, and `DropZoneView` insertion logic intact.                                                                                           |
| `Clop/Images.swift`                          | `Core/Optimizers/ImageOptimizer.cs`                                        | Full image pipeline (pngquant/jpegoptim/gifsicle/vipsthumbnail), transparent EXIF copy, metadata stripping, retina downscale, and conversion to AVIF/HEIC/WEBP. Requires multi-step comparison logic to decide PNG↔JPEG swaps.                                 |
| `Clop/InstallCLI.swift`                      | `CliBridge/Installer.cs`                                                   | Installs CLI by creating symlinks and exporting PATH entries; Windows version should set `%LOCALAPPDATA%\Microsoft\WindowsApps` shim or ship a MSI that registers the command.                                                                                 |
| `Clop/Migrations.swift`                      | `Core/Settings/Migrations.cs`                                              | Migrates `.clopignore` files per media type. Needs to run before watchers start to avoid reprocessing already ignored folders.                                                                                                                                 |
| `Clop/NSImageExtensions.swift`               | `App/Interop/ImageExtensions.cs`                                           | Image gamma/resize/crop helpers backing previews and retina handling. Replace with Win2D/ComputeShader equivalents but preserve even-dimension guarantees.                                                                                                     |
| `Clop/Onboarding.swift`                      | `App/Views/OnboardingWizard.xaml(.cs)`                                     | Animated onboarding that demos drag-and-drop and presets. Maintain timing cues and ability to reopen from Settings for parity.                                                                                                                                 |
| `Clop/Optimisable.swift`                     | `Core/Optimizers/Optimisable.cs`                                           | Base class for media types. Handles thumbnail generation, optimiser lookup, and shortcut replays. Windows base needs caching + hash reuse across derived optimisers.                                                                                           |
| `Clop/OptimisationUtils.swift`               | `Core/Optimizers/OptimisationCoordinator.cs`                               | Defines `ItemType`, optimiser view models, clipboard scheduling, caching, and process orchestration. The Windows port exposes a channel-backed coordinator with progress events, cancellation, and typed requests/results to keep CLI/Shortcuts compatible.    |
| `Clop/PDF.swift`                             | `Core/Optimizers/PdfOptimizer.cs`                                          | Ghostscript-driven workflow, cropping helpers, xattr tagging, and PDFKit guards. Windows version must match the `gsArgs` stack and page-progress reporting.                                                                                                    |
| `Clop/PresetZones.swift`                     | `App/Views/DropZoneSettings.xaml(.cs)`                                     | CRUD UI for preset drop zones tied to Shortcuts and file types. Keep validation (name/icon/shortcut required) and editing workflow.                                                                                                                            |
| `Clop/ResolutionField.swift`                 | `App/Controls/ResolutionField.xaml(.cs)`                                   | Per-optimiser crop/downscale editor with orientation toggles and saved presets. Mirrors `Defaults.savedCropSizes` and smart-crop logic.                                                                                                                        |
| `Clop/RightClickMenu.swift`                  | `App/Views/ContextMenus/OptimiserContextMenu.xaml(.cs)`                    | Contextual menu wiring (open, restore, compare, downscale, automation). Also enumerates "Open With" apps; Windows port should query shell verbs similarly.                                                                                                     |
| `Clop/Settings.swift`                        | `Core/Settings/SettingsRegistry.cs`, `SettingsStore.cs`, `SettingsHost.cs` | All Defaults keys, enums, limits, and feature flags. Registry + store persist to `%AppData%/Clop/config.json`, expose typed getters/setters, run migrations on load, and raise change events for WPF bindings.                                                 |
| `Clop/SettingsView.swift`                    | `App/Views/SettingsPage.xaml(.cs)`                                         | Multi-tab settings UI binding directly to `Defaults`. Includes drop-zone, automation, presets, telemetry opt-ins, and the Buy-Me-A-Coffee panel so users can donate without feature gating.                                                                    |
| `Clop/Uploads.swift`                         | `Integrations/Uploads/*.cs`                                                | Integrations with Dropshare/Yoink/Dockside including discovery via metadata queries and automation toggles. Replace with Share UI / WinAppSDK share targets but keep dismissal heuristics.                                                                     |
| `Clop/Video.swift`                           | `Core/Optimizers/VideoOptimizer.cs`                                        | Controls ffmpeg runs, progress scraping, fps caps, audio stripping, GIF conversions via gifski, and metadata copy. Windows port must keep the adaptive encoding heuristics (`useAggressiveOptimisation`).                                                      |
| `Clop/Xattr.swift`                           | `Core/IO/FileMetadata.cs`                                                  | Thin xattr wrapper to mark optimisation status. Map to NTFS Alternate Data Streams (e.g., `:clop.optimisation.status`) and keep timeout/cancellation guard.                                                                                                    |
| `ClopCLI/main.swift`                         | `CliBridge/Program.cs`                                                     | ArgumentParser-based CLI, ensures GUI app is running, forwards requests over Mach ports, formats help text, and shares size/crop parsing logic. Share the same tokens (`%y`, `%f`, etc.) across platforms.                                                     |
| `ClopCLI/Colorize.swift`                     | `CliBridge/Console/Colorize.cs`                                            | ANSI colour helper for CLI output, including enable/disable toggles via `isatty`. Wrap Windows Console APIs but keep method names for reuse.                                                                                                                   |
| `FinderOptimiser/ActionRequestHandler.swift` | `Integrations/Explorer/ContextMenuHandler.cpp/.cs`                         | Finder extension plumbing that copies sandboxed files, listens for optimiser responses, and handles completion/error propagation. Windows Explorer extension must mimic attachment batching and timeout handling.                                              |

## Keyboard & Input

- `App/Infrastructure/ShortcutCatalog.cs` centralises WPF accelerators (`Ctrl+O`, `Ctrl+,`, `Ctrl+1`–`3`) so navigation and browse actions stay in sync with macOS defaults.
- `App/Services/KeyboardShortcutService.cs` registers global shortcuts via `user32.RegisterHotKey`, using the shared `ShortcutCatalog` metadata and Windows `MOD_NOREPEAT` to prevent repeats.
- Global "Sauce" shortcuts default to `Ctrl+Shift` combos (`Space`, `F`, `C`) that focus the main window, toggle floating results, and toggle the clipboard optimiser.
- Pointer gestures mirror macOS drop-zone behaviour: standard drag drops onto the floating HUD, holding `Alt` reveals the full drop-zone overlay, and pressing `Ctrl` while dragging exposes preset zones. Right-click continues to surface the per-result context menu for restore/compare actions, matching SwiftUI interactions.
